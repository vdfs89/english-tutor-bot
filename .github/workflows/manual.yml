name: Build and Deploy English Tutor Bot

on:
  push:
    branches:
      - main  # O deploy acontece toda vez que você der push para a main
      - staging
    paths:
      - 'lingua_flow_app/**'
      - '.github/workflows/manual.yml'
      - 'index.html'
      - 'html-version/**'
      - 'interface_streamlit.py'
      - '!**.md'

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Faz o checkout do seu código
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Instala o Flutter no servidor do GitHub
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # Cache das dependências do Flutter (Pub Cache) para acelerar o build
      - name: Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('lingua_flow_app/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      # 3. Resolve as dependências e constrói a versão Web do Flutter
      - name: Build Flutter Web
        run: |
          cd lingua_flow_app
          flutter pub get

          # Determine base-href based on branch
          if [[ "${{ github.ref_name }}" == "staging" ]]; then
            BASE_HREF="/english-tutor-bot/staging/"
          else
            BASE_HREF="/english-tutor-bot/flutter-version/"
          fi

          flutter build web --release --base-href "$BASE_HREF"

      # 4. Organiza os arquivos para o deploy final
      - name: Prepare Deployment Folder
        run: |
          mkdir -p deploy/python-version
          # Copia a Landing Page principal
          cp index.html deploy/
          cp robots.txt deploy/
          cp sitemap.xml deploy/
          cp privacy-policy.html deploy/
          # Copia a versão HTML/JS
          cp -r html-version/ deploy/

          # Determine destination folder based on branch
          if [[ "${{ github.ref_name }}" == "staging" ]]; then
            FLUTTER_DEST="deploy/staging"
          else
            FLUTTER_DEST="deploy/flutter-version"
          fi
          mkdir -p "$FLUTTER_DEST"
          # Copia os arquivos compilados do Flutter
          cp -r lingua_flow_app/build/web/* "$FLUTTER_DEST/"
          # Copia os arquivos da versão Python para download/visualização
          cp interface_streamlit.py deploy/python-version/
          cp requirements.txt deploy/python-version/
          cp README.md deploy/python-version/

      # 3. Envia tudo para a branch 'gh-pages' que o GitHub usa para o site
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: deploy
          branch: gh-pages
